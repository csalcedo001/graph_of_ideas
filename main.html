<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@4.0.16/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Connect Objects demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <p id="text"></p>
    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
      id: "stage",
        container: 'container',
        width: width,
        height: height,
        draggable: true
      });



      var layer = new Konva.Layer({
        id: "layer"
      });

      stage.add(layer);

      var nodes = {};
      var edges = {};

      var nodeID = 0;
      function nodeNextID() {
        return (nodeID++).toString();
      }

      var edgeID = 0;
      function edgeNextID() {
        return (edgeID++).toString();
      }

      function edgeTargetPosition(source, target) {
        var xVector = target.group.x() - source.group.x();
        var yVector = target.group.y() - source.group.y();
        var h = Math.sqrt(Math.pow(xVector, 2) + Math.pow(yVector, 2));

        return {
          x: target.group.x() - target.circle.radius() * xVector / h,
          y: target.group.y() - target.circle.radius() * yVector / h
        };
      }
      var group = new Konva.Group({x:1000,y:1000});
      group.add(new Konva.Circle({x:0,y:0,radius:100,fill:"green",id:"node"}));
      layer.add(group);

      stage.on("dblclick", function(e) {
        if (e.target.id() == "stage") {
          var position = stage.getPointerPosition();
          var id = nodeNextID();

          var newNode = new Konva.Group({
            id: "node-".concat(id),
            x: position.x - stage.x(),
            y: position.y - stage.y(),
            draggable: true
          })

          var newCircle = new Konva.Circle({
            id: "circle-".concat(id),
            radius: 100,
            x: 0,
            y: 0,
            fill: 'green',
          });

          var text = new Konva.Text({
            id: "text-".concat(id),
            x: 0,
            y: 0,
            text: "Test text"
          });

          text.x(-text.width() / 2);
          text.y(-text.height() / 2);

          nodes[newNode.id()] = {
            group: newNode,
            circle: newCircle,
            text: text,
            edges: []
          };

          newNode.add(newCircle);
          newNode.add(text);

          newNode.on("dragmove", () => {
            nodes[newNode.id()].edges.forEach(edgeID => {
              var edge = edges[edgeID];
              position = edgeTargetPosition(nodes[edge.source.id()], nodes[edge.target.id()]);

              edge.edge.points([edge.source.x(), edge.source.y(), position.x, position.y]);
            });

            stage.draw();
          });

          layer.add(newNode);
          layer.batchDraw();
        };
      });


      var mouseX, mouseY;
      var newEdgeAnimation = new Konva.Animation(function(frame){}),
          newEdge,
          newEdgeSource;
      var currentTarget = stage;

      stage.on("mousemove", function(e) {
        var position = stage.getPointerPosition();
        mouseX = position.x - stage.x();
        mouseY = position.y - stage.y();

        currentTarget = e.target.id()[0] == "c" || e.target.id()[0] == "t" ?
          e.target.getParent() :
          stage;

        document.getElementById('text').textContent = currentTarget.id();
      });


      stage.on("mousedown", function(e) {
        if (currentTarget.id()[0] == "n" && window.event.metaKey) {
          if (newEdgeAnimation.isRunning()) {
            newEdgeAnimation.stop();
            newEdge.destroy();
          }

          newEdgeSource = currentTarget;

          newEdge = new Konva.Arrow({
            id: "arrow-".concat(edgeNextID()),
            stroke: 'black'
          });

          newEdgeAnimation = new Konva.Animation(function (frame) {
            var targetX, targetY;

            if (currentTarget.id()[0] == "n" && currentTarget != newEdgeSource) {
              var position = edgeTargetPosition(nodes[newEdgeSource.id()], nodes[currentTarget.id()]);

              targetX = position.x;
              targetY = position.y;
            } else {
              targetX = mouseX;
              targetY = mouseY;
            }

            newEdge.points([newEdgeSource.x(), newEdgeSource.y(), targetX, targetY]);
          }, layer);

          layer.add(newEdge);
          newEdge.moveToBottom();
          newEdgeSource.draggable(false);

          newEdgeAnimation.start();
        }
      });

      stage.on("mouseup", function(e) {
        if (newEdgeAnimation.isRunning()) {
          newEdgeAnimation.stop();
          newEdgeSource.draggable(true);

          if (currentTarget.id()[0] == "n") {
            edges[newEdge.id()] = {
              edge: newEdge,
              source: newEdgeSource,
              target: currentTarget
            };
            nodes[newEdgeSource.id()].edges.push(newEdge.id());
            nodes[currentTarget.id()].edges.push(newEdge.id());
          } else {
            newEdge.destroy();
          }

          layer.batchDraw();
        }
      });

      // var text = new Konva.Text({
      //   text: 'Hola',
      //   x: 100,
      //   y: 100
      // })

      // layer.add(text);

      // var tr = new Konva.Transformer({
      //   node: circle,
      //   enabledAnchors: ['top-center', 'bottom-center', 'middle-left', 'middle-right'],
      //   visible: false,
      //   // set minimum width of text
      //   boundBoxFunc: function(oldBox, newBox) {
      //     newBox.width = Math.max(30, newBox.width);
      //     newBox.height = Math.max(30, newBox.height);
      //     return newBox;
      //   }
      // });

      // layer.add(tr);

      // circle.on('dragmove', function() {
      //   text.x(circle.x());
      //   text.y(circle.y());
      // });

      // circle.on('click', function() {
      //   tr.visible(true);
      // });

      // circle.on('transform', function() {
      //   circle.setAttrs({
      //     width: circle.width() * circle.scaleX(),
      //     height: circle.height() * circle.scaleY(),
      //     scaleX: 1,
      //     scaleY: 1
      //   });

      //   text.x(circle.x());
      //   text.y(circle.y());
      //   text.rotation(circle.rotation());
      // });

      // layer.batchDraw();
    </script>
  </body>
</html>
