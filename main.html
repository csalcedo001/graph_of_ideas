<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@4.0.16/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Connect Objects demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <p id="text"></p>
    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
	    id: "stage",
        container: 'container',
        width: width,
        height: height,
		draggable: true
      });


      var layer = new Konva.Layer({
	    id: "layer"
	  });

	  stage.add(layer);


	  var ids = 0;

	  function getNextId() {
	    return (ids++).toString();
	  }

      var currentTarget = stage;

	  stage.on("mouseover", function(e) {
	    currentTarget = stage;
	  });

	  stage.on("dblclick", function(e) {
		var position = stage.getPointerPosition();

	    if (e.target.id() == "stage") {
          var newCircle = new Konva.Circle({
		    id: "circle-".concat(getNextId()),
            radius: 100,
            x: position.x - stage.x(),
            y: position.y - stage.y(),
            fill: 'green',
            draggable: true
          });

		  newCircle.on("mouseover", function (e) {
            currentTarget = newCircle;
		  });

          layer.add(newCircle);
	      layer.batchDraw();
		}
      });


	  var mouseX, mouseY;
	  var newArrowAnimation = new Konva.Animation(function(frame){}),
	      newArrow,
		  newArrowSource;

	  stage.on("mousemove", function(e) {
	  	var positions = stage.getPointerPosition();
        mouseX = positions.x;
		mouseY = positions.y;

		if (arrowAnimation.isRunning()) {
		  if (e.target.id()) {
            newArrow; // Complete...
		  }
		}
	  });


	  stage.on("mousedown", function(e) {
	    if (e.target.id() != "stage" && window.event.metaKey) {
		  newArrowSource = e.target;

	      newArrow = new Konva.Arrow({
			id: "arrow",
	        points: [mouseX - stage.x(), mouseY - stage.y(), mouseX - stage.x(), mouseY - stage.y()],
	        stroke: 'black'
	      });

          newArrowAnimation = new Konva.Animation(function (frame) {
		    var positions = stage.getPointerPosition();
			mouseX = positions.x;
			mouseY = positions.y;
		    newArrow.points([newArrowSource.x(), newArrowSource.y(), mouseX - stage.x(), mouseY - stage.y()]);
	        document.getElementById('text').textContent = mouseX - stage.x();
		  }, layer);

	      layer.add(newArrow);
		  newArrow.moveToBottom();
		  newArrowSource.draggable(false);

		  newArrowAnimation.start();
		}
      });

	  stage.on("mouseup", function(e) {
	    if (newArrowAnimation.isRunning()) {
	      newArrowAnimation.stop();
		  newArrowSource.draggable(true);

		  if (e.target.id()[0] == "c") {
		    newArrow.points([newArrowSource.x(), newArrowSource.y(), e.target.x(), e.target.y()]);
		  } else {
		    newArrow.destroy();
		  }

	      layer.batchDraw();
		}
	  });

      // var text = new Konva.Text({
      //   text: 'Hola',
      //   x: 100,
      //   y: 100
      // })

      // layer.add(text);

      // var tr = new Konva.Transformer({
      //   node: circle,
      //   enabledAnchors: ['top-center', 'bottom-center', 'middle-left', 'middle-right'],
      //   visible: false,
      //   // set minimum width of text
      //   boundBoxFunc: function(oldBox, newBox) {
      //     newBox.width = Math.max(30, newBox.width);
      //     newBox.height = Math.max(30, newBox.height);
      //     return newBox;
      //   }
      // });

      // layer.add(tr);

      // circle.on('dragmove', function() {
      //   text.x(circle.x());
      //   text.y(circle.y());
      // });

      // circle.on('click', function() {
      //   tr.visible(true);
      // });

      // circle.on('transform', function() {
      //   circle.setAttrs({
      //     width: circle.width() * circle.scaleX(),
      //     height: circle.height() * circle.scaleY(),
      //     scaleX: 1,
      //     scaleY: 1
      //   });

      //   text.x(circle.x());
      //   text.y(circle.y());
      //   text.rotation(circle.rotation());
      // });

      // layer.batchDraw();
    </script>
  </body>
</html>
