<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@4.0.16/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Connect Objects demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <p id="text"></p>
    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
      id: "stage",
        container: 'container',
        width: width,
        height: height,
        draggable: true
      });


      var layer = new Konva.Layer({
        id: "layer"
      });

      stage.add(layer);

      var nodes = {};
      var edges = {};

      var nodeID = 0;
      function nodeNextID() {
        return (nodeID++).toString();
      }

      var edgeID = 0;
      function edgeNextID() {
        return (edgeID++).toString();
      }

      function edgeTargetPosition(source, target) {
        var xVector = target.x() - source.x();
        var yVector = target.y() - source.y();
        var h = Math.sqrt(Math.pow(xVector, 2) + Math.pow(yVector, 2));

        return {
          x: target.x() - target.radius() * xVector / h,
          y: target.y() - target.radius() * yVector / h
        };
      }

      stage.on("dblclick", function(e) {
        if (e.target.id() == "stage") {
          var position = stage.getPointerPosition();

          var newCircle = new Konva.Circle({
            id: "circle-".concat(nodeNextID()),
            radius: 100,
            x: position.x - stage.x(),
            y: position.y - stage.y(),
            fill: 'green',
            draggable: true
          });

          nodes[newCircle.id()] = {
            obj: newCircle,
            edges: []
          };

          newCircle.on("dragmove", () => {
            nodes[newCircle.id()].edges.forEach(edgeID => {
              var edge = edges[edgeID];
              position = edgeTargetPosition(edge.source, edge.target);

              edge.obj.points([edge.source.x(), edge.source.y(), position.x, position.y]);
            });
            document.getElementById('text').textContent = "OK";

            stage.draw();
          });


          layer.add(newCircle);
          layer.batchDraw();
        };
      });


      var mouseX, mouseY;
      var newEdgeAnimation = new Konva.Animation(function(frame){}),
          newEdge,
          newEdgeSource;
      var currentTarget = stage;

      stage.on("mousemove", function(e) {
        var position = stage.getPointerPosition();
        mouseX = position.x - stage.x();
        mouseY = position.y - stage.y();

        currentTarget = e.target.id()[0] == "c" ? e.target : stage;
      });


      stage.on("mousedown", function(e) {
        if (e.target.id()[0] == "c" && window.event.metaKey) {
          if (newEdgeAnimation.isRunning()) {
            newEdgeAnimation.stop();
            newEdge.destroy();
          }

          newEdgeSource = e.target;

          newEdge = new Konva.Arrow({
            id: "arrow-".concat(edgeNextID()),
            stroke: 'black'
          });

          newEdgeAnimation = new Konva.Animation(function (frame) {
            var targetX, targetY;

            if (currentTarget.id()[0] == "c" && currentTarget != newEdgeSource) {
              var position = edgeTargetPosition(newEdgeSource, currentTarget);

              targetX = position.x;
              targetY = position.y;
            } else {
              targetX = mouseX;
              targetY = mouseY;
            }

            newEdge.points([newEdgeSource.x(), newEdgeSource.y(), targetX, targetY]);
          }, layer);

          layer.add(newEdge);
          newEdge.moveToBottom();
          newEdgeSource.draggable(false);

          newEdgeAnimation.start();
        }
      });

      stage.on("mouseup", function(e) {
        if (newEdgeAnimation.isRunning()) {
          newEdgeAnimation.stop();
          newEdgeSource.draggable(true);

          if (e.target.id()[0] == "c") {
            edges[newEdge.id()] = {
              obj: newEdge,
              source: newEdgeSource,
              target: currentTarget
            };
            nodes[newEdgeSource.id()].edges.push(newEdge.id());
            nodes[currentTarget.id()].edges.push(newEdge.id());
          } else {
            newEdge.destroy();
          }

          layer.batchDraw();
        }
      });

      // var text = new Konva.Text({
      //   text: 'Hola',
      //   x: 100,
      //   y: 100
      // })

      // layer.add(text);

      // var tr = new Konva.Transformer({
      //   node: circle,
      //   enabledAnchors: ['top-center', 'bottom-center', 'middle-left', 'middle-right'],
      //   visible: false,
      //   // set minimum width of text
      //   boundBoxFunc: function(oldBox, newBox) {
      //     newBox.width = Math.max(30, newBox.width);
      //     newBox.height = Math.max(30, newBox.height);
      //     return newBox;
      //   }
      // });

      // layer.add(tr);

      // circle.on('dragmove', function() {
      //   text.x(circle.x());
      //   text.y(circle.y());
      // });

      // circle.on('click', function() {
      //   tr.visible(true);
      // });

      // circle.on('transform', function() {
      //   circle.setAttrs({
      //     width: circle.width() * circle.scaleX(),
      //     height: circle.height() * circle.scaleY(),
      //     scaleX: 1,
      //     scaleY: 1
      //   });

      //   text.x(circle.x());
      //   text.y(circle.y());
      //   text.rotation(circle.rotation());
      // });

      // layer.batchDraw();
    </script>
  </body>
</html>
