<!DOCTYPE html>
<html>
	<head>
		<title>Idea graph</title>
	</head>

	<body>
		<h1>Ideas...</h1>
		<canvas id=board style="width=100%; height=100%; margin=0; border:1px solid #000000;">
	</body>

	<script>
		var canvas = document.getElementById("board");
		var ctx = canvas.getContext("2d");

		ctx.canvas.width = window.innerWidth;
		ctx.canvas.height = window.innerHeight;

		// Circle id count
		var objectCount = 0;

		// Objects indexed by id
		var objectMap = {};

		// Classes

		const Circle = class {
			constructor(x, y, r) {
				// Object unique ID
				this.id = objectCount;
				objectCount++;

				// Add object to global object mapping
				objectMap[this.id] = this;
				
				// Object positioning and color
				this.move(x, y);
				this.r = r;
				this.color = "#FFFFFF";

				// Text to be displayed in object
				this.text = "";

				// Object of indices
				// TODO : Replace by array, since object cant be sorted?
				this.outNeighbors = {};
				// TODO : Replace by actual auto call in outNeighbors?
				this.selfNeighbor = false; // For multigraphs, represent by number
			}

			draw() {
				// Draw the circle
				ctx.fillStyle = this.color;
				ctx.beginPath();
				ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
				ctx.stroke();
				ctx.fill();

				// Print text inside circle
				ctx.fillStyle = "black";
				ctx.font = "10px Arial";
				ctx.fillText(this.text, this.x, this.y);
			}

			move(x, y) {
				this.x = x;
				this.y = y;
			}

			// Test whether the object contains point (x, y)
			contains(x, y) {
				return Math.sqrt(
					(x - this.x) * (x - this.x) +
					(y - this.y) * (y - this.y)
				) <= this.r;
			}

			// Update color
			paint(color) {
				this.color = color;
			}

			// Update text
			say(text) {
				this.text = text;
			}

			connect(obj) {
				if (obj.id == this.id) {
					this.selfNeighbor = true;
				} else {
					this.outNeighbors[id] = obj;
				}
			}
		}

		// Initial circle
		var originObject = new Circle(400, 400, 50);
		
		delete objectMap[objectCount - 1];
		originObject.outNeighbors = objectMap;

		// Better name: currentObject -> backgroundObject
		var currentObject = originObject;
		var selectedObject = originObject;

		for (var i = 0; i < 10; i++) {
			var newObject = new Circle(15 * i, 10 * i, 40);
			newObject.say(newObject.id.toString());
		}



		// Functions
		
		// Mouse coordinates
		var mouseX, mouseY;

		// Update mouse coordinates
		function mouseUpdate(evt) {
			var rect = canvas.getBoundingClientRect();

			mouseX = evt.clientX - rect.left;
			mouseY = evt.clientY - rect.top;
		}

		// Obtain object in mouse coordinates
		function touchedObject() {
			var objects = Object.values(objectMap);

			for (var i = objects.length - 1; i >= 0; i--) {
				if (objects[i].contains(mouseX, mouseY)) {
					return objects[i];
				}
			}

			return currentObject;
		}
		
		// Mouse object selection process
		function mouseSelect() {
			var touched = touchedObject();

			if (touched.id != currentObject.id) {
				selectedObject.paint("white");
				selectedObject = touched;
				selectedObject.paint("red");
			} else {
				selectedObject.paint("white");
				selectedObject = touched;
			}
		}

		var mouseHoldEvent = null;

		function mousePressEvent(evt) {
			if (!evt.metaKey) {
				mouseSelect();

				if (selectedObject.id != currentObject.id) {
					var xdiff = selectedObject.x - mouseX;
					var ydiff = selectedObject.y - mouseY;

					mouseHoldEvent = setInterval(function(evt) {
						selectedObject.move(mouseX + xdiff, mouseY + ydiff);
					}, 5);
				} // else, move screen
			}
		}

		function mouseReleaseEvent(evt) {
			if (selectedObject.id != currentObject.id) {
				clearInterval(mouseHoldEvent);
			} // else, stop moving screen
		}


		// Events
		canvas.addEventListener("mousemove", mouseUpdate, false);
		canvas.addEventListener("mousedown", mousePressEvent, false);
		canvas.addEventListener("mouseup", mouseReleaseEvent, false);
		canvas.addEventListener("mouseleave", mouseReleaseEvent, false);
		canvas.addEventListener("dblclick", function (evt) {
			mouseSelect();

			if (selectedObject.id == currentObject.id) {
				var newObject = new Circle(mouseX, mouseY, 20);

				selectedObject.connect(newObject);
			} else {
				selectedObject.paint("blue");
			}
		}, false);
		
		var console = new Circle(250, 250, 40);
		console.paint("red");

		function draw() {
			ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
			
			console.say(mouseX.toString());
			console.draw();
			console.say(touchedObject().id.toString());

			for (key in currentObject.outNeighbors) {
				objectMap[key].draw();
			}
		}

		setInterval(draw, 10);
	</script>
</html>
